<!DOCTYPE HTML>
<html lang="pl-PL" xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Getting Started: Serving Web Content</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <link href="../static/css/style.css" th:href="@{/css/style.css}" type="text/css" rel="stylesheet"/>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.19.0/jquery.validate.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.19.0/additional-methods.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <script>
        /*<![CDATA[*/
        var mountainRanges = null;
        var mountainGroups = null;
        var data = [];

        function changeMountainRangesListener() {
            var mountainRangesSelector = $("#mountainRangesSelectList");
            var mountainGroupsSelector = $("#mountainGroupsSelectList");

            mountainGroupsSelector.find('option')
                .remove()
                .end();
            // console.log();
            var option = new Option("", "", true, true);
            mountainGroupsSelector.append(option);
            console.log(data.length);
            console.log(data);
            console.log(mountainRangesSelector.val());
            length = data.length;
            for (i = 0; i < length; i++) {
                // console.log(data[i].mountainRange.id);
                // console.log(mountainRangesSelector.val());
                if (data[i].mountainRange.id == mountainRangesSelector.val()) {
                    option = new Option(data[i].name, data[i].id, false, false);
                    mountainGroupsSelector.append(option);
                }
            }
        }

        /*]]>*/
    </script>

    <script th:each="item:${mountainGroups}" th:inline="javascript">
        data.push([[${item}]]);
    </script>

    <script>
        $(document).ready(function () {

            $("#save_section").click(function (e) {
                e.preventDefault();
                // alert("post data to add new section");
                var data = {};
                data["mountainGroup"] = $("#mountainGroupsSelectList").val();
                data["locationOne"] = $("#locationOne").val();
                data["locationTwo"] = $("#locationTwo").val();
                data["distance"] = $("#distance").val();
                data["pointsAltitude"] = $("#pointsAltitude").val();
                data["pointsDistance"] = $("#pointsDistance").val();
                console.log($("#save_section_form").url);
                console.log(data);
                $.post({
                    url: $("#save_section_form").attr("action"),
                    data: JSON.stringify(data),
                    contentType: 'application/json; charset=utf-8',
                    dataType: 'json',
                    success: function (data) {
                        console.log(data.status);
                        console.log(data.body);
                        $("#dialog-message").css("color", "green");
                        $("#dialog-message").html("Zaktualizowano stan odcinka");
                        $("#new_section_form").trigger("reset");
                    },
                    error: function (data) {
                        console.log(data.status);
                        console.log(data.body);
                        console.log(data);
                        var errors = JSON.parse(data.responseText);
                        console.log(errors);
                        var errTable = {
                            1: "Lokalizacja pierwsza i druga nie mogą być identyczne",
                            2: "Dystans pomiędzy lokalizacjami musi być podany",
                            3: "Grupa górska szlaku musi być podana",
                            4: "W bazie istnieje już odcinek z "
                            + $("#locationOne option:selected").text()
                            + " do " + $("#locationTwo option:selected").text()
                        };
                        var strErr = "";
                        for (var i = 0; i < errors.length; i++) {
                            strErr += errTable[errors[i]] + "</br>"
                        }
                        $("#dialog-message").css("color", "red");
                        $("#dialog-message").html(strErr);

                    }


                });
                var dialog = $("#dialog-message").dialog({
                    autoOpen: false,
                    modal: true,
                    buttons: {
                        Ok: function () {
                            $(this).dialog("close");
                        }
                    }
                });
                dialog.dialog("open");
            });
        });
    </script>

    <script>
        var dialog;
        $(function () {
            dialog = $("#dialog-message").dialog({
                autoOpen: false,
                modal: true,
                buttons: {
                    Ok: function () {
                        $(this).dialog("close");
                    }
                }
            });
        })

    </script>

</head>
<body>
<div id="dialog-message" title="Status operacji">

</div>
<script>
    /*<![CDATA[*/
    mountainRanges = "[[${mountainRanges}]]";
    mountainGroups = "[[${mountainGroups}]]";
    console.log(mountainRanges);
    console.log(mountainGroups);
    /*]]>*/
</script>

<p class="header">
    <img class="header" src="../static/images/pttk_logo.jpg" th:src="@{/images/pttk_logo.jpg}" width="100"
         alt="Logo Pttk">
    Edytuj odcinek punktowany do GOT
    <a style="float: right;" href="/sections/" class="button_grey">Anuluj</a>
</p>

<form id="save_section_form" th:action="@{/sections/edit/save/{id}(id=${section.getId()})}" method="post">
    <table class="sections_details">
        <tr>
            <td class="align_right">Pasmo górskie:</td>
            <td>
                <select class="select_section_param" id="mountainRangesSelectList" name="mountainRange"
                        onchange="changeMountainRangesListener();">
                    <option th:each="mr : ${mountainRanges}"
                            th:value="${mr.getId()}"
                            th:text="${mr.getName()}"
                            th:selected="${mr.getId()==section.getMountainGroup().getMountainRange().getId()}"></option>
                </select>
            </td>
        </tr>
        <tr>
            <td class="align_right">Grupa górska:</td>
            <td>
                <select class="select_section_param" name="mountainGroup" id="mountainGroupsSelectList">
                    <th:block th:each="mg : ${mountainGroups}">
                        <option th:if="${mg.getMountainRange().getId()==section.getMountainGroup().getMountainRange().getId()}"
                                th:value="${mg.getId()}"
                                th:text="${mg.getName()}"
                                th:selected="${mg.getId()==section.getMountainGroup().getId()}"></option>
                    </th:block>
                </select>
            </td>
        </tr>
        <tr>
            <td class="align_right">Lokalizacja pierwsza:</td>
            <td>
                <select class="select_section_param" name="locationOne" id="locationOne">
                    <option th:each="l : ${locations}"
                            th:value="${l.getId()}"
                            th:text="${l.getName()}"
                            th:selected="${l.getId()==section.getLocationOne().getId()}"></option>
                </select>
            </td>
        </tr>
        <tr>
            <td class="align_right">Lokalizacja druga:</td>
            <td>
                <select class="select_section_param" name="locationTwo" id="locationTwo">
                    <option th:each="l : ${locations}"
                            th:value="${l.getId()}" th:text="${l.getName()}"
                            th:selected="${l.getId()==section.getLocationTwo().getId()}"></option>
                </select>
            </td>
        </tr>
        <tr>
            <td class="align_right">Odległość:</td>
            <td>
                <input class="select_section_param" name="distance" id="distance" type="number" min=0
                       th:value="${section.getDistance()}">
            </td>
        </tr>
        <tr>
            <td class="align_right">Punkty za wysokość:</td>
            <td>
                <select class="select_section_param" name="pointsAltitude" id="pointsAltitude">
                    <option th:each="i : ${#numbers.sequence(0, 20)}" th:value="${i}" th:text="${i}"
                            th:selected="${i==section.getPointsAltitude()}"></option>
                </select>
            </td>
        </tr>
        <tr>
            <td class="align_right">Punkty za odległość:</td>
            <td>
                <select class="select_section_param" name="pointsDistance" id="pointsDistance">
                    <option th:each="i : ${#numbers.sequence(0, 20)}" th:value="${i}" th:text="${i}"
                            th:selected="${i==section.getPointsDistance()}"></option>
                </select>
            </td>
        </tr>
        <tr>
            <td>
            </td>
            <td>
                <input class="select_section_param" type="submit" value="Zapisz" id="save_section">
            </td>
        </tr>
    </table>
    <!--<input type="submit" value="Zapisz"-->
    <!--style="padding: 10px;float: right">-->
</form>

</body>
</html>